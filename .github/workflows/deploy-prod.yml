name: Gamegoo v2 API PROD CI/CD

on:
  pull_request:
    types: [ closed ]
    branches:
      - main
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê ÏßÅÏ†ë Ìë∏ÏãúÎê† ÎïåÎèÑ Ïã§Ìñâ
  workflow_dispatch:

jobs:
  build-and-deploy: # Job Ïù¥Î¶Ñ
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest # Ïã§Ìñâ ÌôòÍ≤Ω - Í∞ÄÏû• ÏµúÏã† Î≤ÑÏ†Ñ Ubuntu ÌôòÍ≤Ω

    env: # Ï†ÑÏ≤¥ jobÏóêÏÑú ÏÇ¨Ïö©Ìï† ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      RDS_PRIVATE_IP: ${{ secrets.RDS_PRIVATE_IP }}
      RDS_PORT: ${{ secrets.RDS_PORT }}
      PROD_DB_SCHEMA_NAME: ${{ secrets.PROD_DB_SCHEMA_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      GMAIL_PWD: ${{ secrets.GMAIL_PWD }}
      RIOT_API: ${{ secrets.RIOT_API }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_MONITORING_WEBHOOK_URL_PROD: ${{ secrets.DISCORD_MONITORING_WEBHOOK_URL_PROD }}
      DISCORD_SCHEDULER_WEBHOOK: ${{ secrets.DISCORD_SCHEDULER_WEBHOOK }}
      SOCKET_SERVER_URL: ${{ secrets.SOCKET_SERVER_URL }}
      FRONT_URL: ${{ secrets.FRONT_URL }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      RSO_REDIRECT_URI: ${{ secrets.PROD_RSO_REDIRECT_URI }}
      ADMIN_COMMON_PASSWORD: ${{ secrets.ADMIN_COMMON_PASSWORD }}

    steps:
      # 1. GitHub Repository ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
      - name: Github Repository ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
        uses: actions/checkout@v4

      # 2. Í∂åÌïú ÏÑ§Ï†ï
      - name: gradlew Í∂åÌïú ÏÑ§Ï†ï
        run: chmod +x ./gradlew
        shell: bash

      # 3. JDK 17 ÏÑ§Ïπò
      - name: JDK 17 ÏÑ§Ïπò
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle Build (PROD)
        run: ./gradlew clean build -x test

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 \
            -o /usr/local/bin/cloudflared
          chmod +x /usr/local/bin/cloudflared

      # 4. Docker ÌôïÏû• Í∏∞Îä• Ï∂îÍ∞Ä
      - name: Docker ÌôïÏû• Í∏∞Îä• Ï∂îÍ∞Ä
        uses: docker/setup-buildx-action@v3

      # 5. Docker Hub Î°úÍ∑∏Ïù∏
      - name: Docker Hub Î°úÍ∑∏Ïù∏
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
#
#      # 6. Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î∞è Push
      - name: Docker Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î∞è push
        uses: docker/build-push-action@v6
        with:
          context: . # Dockerfile-prod ÏúÑÏπò
          file: ./Dockerfile-prod # Dockerfile-prod Í≤ΩÎ°ú
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/gamegoo-api-v2-prod:${{ github.sha }} # Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏
          platforms: linux/arm64


      - name: ÌôàÏÑúÎ≤Ñ(Îß•ÎØ∏Îãà)Ïóê Î∞∞Ìè¨ (Cloudflare SSH)
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/gamegoo-api-v2-prod:${{ github.sha }}
          SSH_HOST: ssh.gamegoo.co.kr
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        shell: bash
        run: |
          # SSH key Ï§ÄÎπÑ
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # ssh Ï†ëÏÜç
          ssh -i ~/.ssh/id_rsa \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          -o ProxyCommand="cloudflared access ssh --hostname %h --id ${CF_ACCESS_CLIENT_ID} --secret ${CF_ACCESS_CLIENT_SECRET}" \
          macmini@ssh.gamegoo.co.kr << 'EOF'

          DOCKER_IMAGE="${DOCKER_IMAGE}"

          docker pull "${DOCKER_IMAGE}"
          docker rm -f gamegoo-api-v2-prod || true
          docker run -d \
            --name gamegoo-api-v2-prod \
            -p 8080:8080 \
            --restart=always \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e JWT_SECRET="${JWT_SECRET}" \
            -e RDS_PRIVATE_IP="${RDS_PRIVATE_IP}" \
            -e RDS_PORT="${RDS_PORT}" \
            -e PROD_DB_SCHEMA_NAME="${PROD_DB_SCHEMA_NAME}" \
            -e DB_USERNAME="${DB_USERNAME}" \
            -e DB_PASSWORD="${DB_PASSWORD}" \
            -e GMAIL_PWD="${GMAIL_PWD}" \
            -e RIOT_API="${RIOT_API}" \
            -e SOCKET_SERVER_URL="${SOCKET_SERVER_URL}" \
            -e FRONT_URL="${FRONT_URL}" \
            -e CLIENT_ID="${CLIENT_ID}" \
            -e CLIENT_SECRET="${CLIENT_SECRET}" \
            -e RSO_REDIRECT_URI="${RSO_REDIRECT_URI}" \
            -e DISCORD_MONITORING_WEBHOOK_URL_PROD="${DISCORD_MONITORING_WEBHOOK_URL_PROD}" \
            -e DISCORD_SCHEDULER_WEBHOOK="${DISCORD_SCHEDULER_WEBHOOK}" \
            -e ADMIN_COMMON_PASSWORD="${ADMIN_COMMON_PASSWORD}" \
            "${DOCKER_IMAGE}"

          docker image prune -f || true
          EOF

      # 8. Í∏∞Ï°¥ Docker Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
      - name: Í∏∞Ï°¥ Docker Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
        run: docker image prune -a

      # Ïã§Ìå® Ïãú ÎîîÏä§ÏΩîÎìúÏóê ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞
      - name: Î∞∞Ìè¨ Ïã§Ìå® Ïãú ÎîîÏä§ÏΩîÎìú ÏïåÎ¶º Ï†ÑÏÜ°
        if: failure() # Ïù¥Ï†Ñ Ïä§ÌÖùÏù¥ Ïã§Ìå®Ìïú Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\": \"üö® **Gamegoo v2 API Ïö¥ÏòÅ ÏÑúÎ≤Ñ Î∞∞Ìè¨ Ïã§Ìå®** üö®\nPR Î≤àÌò∏: ${PR_NUMBER}\nPR Ï†úÎ™©: ${PR_TITLE}\nPR ÏûëÏÑ±Ïûê: ${PR_AUTHOR}\n[PR Î≥¥Í∏∞](${PR_URL})\"}" \
          $DISCORD_WEBHOOK_URL
