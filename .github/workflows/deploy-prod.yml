name: Gamegoo v2 API PROD CI/CD

on:
  pull_request:
    types: [ closed ]
    branches:
      - main
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— ì§ì ‘ í‘¸ì‹œë  ë•Œë„ ì‹¤í–‰
  workflow_dispatch:

jobs:
  build-and-deploy: # Job ì´ë¦„
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest # ì‹¤í–‰ í™˜ê²½ - ê°€ì¥ ìµœì‹  ë²„ì „ Ubuntu í™˜ê²½

    env: # ì „ì²´ jobì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      RDS_PRIVATE_IP: ${{ secrets.RDS_PRIVATE_IP }}
      RDS_PORT: ${{ secrets.RDS_PORT }}
      PROD_DB_SCHEMA_NAME: ${{ secrets.PROD_DB_SCHEMA_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      GMAIL_PWD: ${{ secrets.GMAIL_PWD }}
      RIOT_API: ${{ secrets.RIOT_API }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      SOCKET_SERVER_URL: ${{ secrets.SOCKET_SERVER_URL }}
      FRONT_URL: ${{ secrets.FRONT_URL }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      RSO_REDIRECT_URI: ${{ secrets.PROD_RSO_REDIRECT_URI }}
      ADMIN_COMMON_PASSWORD: ${{ secrets.ADMIN_COMMON_PASSWORD }}

    steps:
      # 1. GitHub Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      # 2. ê¶Œí•œ ì„¤ì •
      - name: gradlew ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew
        shell: bash

      # 3. JDK 17 ì„¤ì¹˜
      - name: JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. Docker í™•ì¥ ê¸°ëŠ¥ ì¶”ê°€
      - name: Docker í™•ì¥ ê¸°ëŠ¥ ì¶”ê°€
        uses: docker/setup-buildx-action@v3

      # 5. Docker Hub ë¡œê·¸ì¸
      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. Docker ì´ë¯¸ì§€ ìƒì„± ë° Push
      - name: Docker ì´ë¯¸ì§€ ìƒì„± ë° push
        uses: docker/build-push-action@v6
        with:
          context: . # Dockerfile-prod ìœ„ì¹˜
          file: ./Dockerfile-prod # Dockerfile-prod ê²½ë¡œ
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/gamegoo-api-v2-prod:${{ github.sha }} # ì´ë¯¸ì§€ íƒœê·¸
          platforms: linux/amd64

      ## CD (Continuous Deployment) íŒŒíŠ¸
      # 7. EC2ì— SSHë¡œ ì ‘ì†í•˜ì—¬ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      - name: EC2ì— ë°°í¬
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 í¼ë¸”ë¦­ IP
          username: ubuntu # EC2 ì‚¬ìš©ì (ê¸°ë³¸ì€ ubuntu)
          key: ${{ secrets.EC2_SSH_KEY }} # EC2 SSH Private Key
          script_stop: true # SSH ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì›Œí¬í”Œë¡œ ì¤‘ë‹¨
          script: |
            sudo fuser -k -n tcp 8080 || true

            docker rm -f gamegoo-api-v2-prod

            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/gamegoo-api-v2-prod:${{ github.sha }}

            docker run -d \
            -p 8080:8080 \
            --name gamegoo-api-v2-prod \
            -v ${{ secrets.EC2_LOG_PATH }}:/app/logs \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
            -e RDS_PRIVATE_IP=${{ secrets.RDS_PRIVATE_IP }} \
            -e RDS_PORT=${{ secrets.RDS_PORT }} \
            -e PROD_DB_SCHEMA_NAME=${{ secrets.PROD_DB_SCHEMA_NAME }} \
            -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -e GMAIL_PWD=${{ secrets.GMAIL_PWD }} \
            -e RIOT_API=${{ secrets.RIOT_API }} \
            -e SOCKET_SERVER_URL=${{ secrets.SOCKET_SERVER_URL }} \
            -e FRONT_URL=${{ secrets.FRONT_URL }} \
            -e CLIENT_ID=${{ secrets.CLIENT_ID }} \
            -e CLIENT_SECRET=${{ secrets.CLIENT_SECRET }} \
            -e RSO_REDIRECT_URI=${{ secrets.PROD_RSO_REDIRECT_URI }} \
            -e DISCORD_MONITORING_WEBHOOK_URL_PROD=${{ secrets.DISCORD_MONITORING_WEBHOOK_URL_PROD }} \
            -e DISCORD_SCHEDULER_WEBHOOK=${{ secrets.DISCORD_SCHEDULER_WEBHOOK }} \
            -e ADMIN_COMMON_PASSWORD=${{ secrets.ADMIN_COMMON_PASSWORD }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/gamegoo-api-v2-prod:${{ github.sha }}

      # 8. ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ
      - name: ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ
        run: docker image prune -a

      # ì‹¤íŒ¨ ì‹œ ë””ìŠ¤ì½”ë“œì— ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì „ì†¡
        if: failure() # ì´ì „ ìŠ¤í…ì´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\": \"ğŸš¨ **Gamegoo v2 API ìš´ì˜ ì„œë²„ ë°°í¬ ì‹¤íŒ¨** ğŸš¨\nPR ë²ˆí˜¸: ${PR_NUMBER}\nPR ì œëª©: ${PR_TITLE}\nPR ì‘ì„±ì: ${PR_AUTHOR}\n[PR ë³´ê¸°](${PR_URL})\"}" \
          $DISCORD_WEBHOOK_URL
